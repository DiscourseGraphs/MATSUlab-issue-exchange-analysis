<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVD 1 — Issue Conversion Rate</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #ffffff;
            color: #1f2937;
            padding: 40px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        h1 {
            font-size: 26px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 6px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .evidence-statement {
            background: #f8fafc;
            border-left: 4px solid #3B82F6;
            padding: 16px 20px;
            margin-bottom: 32px;
            font-size: 15px;
            line-height: 1.6;
            color: #374151;
            border-radius: 0 8px 8px 0;
        }

        .evidence-statement strong {
            color: #1e40af;
        }

        /* Two-panel layout */
        .panels {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 40px;
            margin-bottom: 36px;
        }

        .panel {
            position: relative;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 16px;
        }

        /* Stacked bar */
        .bar-container {
            position: relative;
            margin-bottom: 24px;
        }

        .stacked-bar {
            display: flex;
            height: 56px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .bar-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: filter 0.2s, transform 0.15s;
            position: relative;
        }

        .bar-segment:hover {
            filter: brightness(1.12);
            z-index: 2;
        }

        .bar-segment.dim {
            filter: brightness(0.65) saturate(0.4);
        }

        .bar-segment .segment-label {
            pointer-events: none;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: #1f2937;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 100;
            max-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* Bracket */
        .bracket {
            margin-top: 8px;
            text-align: left;
        }

        .bracket-line {
            stroke: #374151;
            stroke-width: 2;
            fill: none;
        }

        .bracket-label {
            font-size: 14px;
            font-weight: 700;
            color: #1e40af;
            margin-top: 4px;
        }

        /* Legend under bar */
        .bar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
            font-size: 13px;
            color: #6b7280;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .legend-item:hover {
            opacity: 0.8;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        /* Donut chart */
        .donut-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .donut-svg {
            width: 220px;
            height: 220px;
            margin-bottom: 16px;
        }

        .donut-arc {
            cursor: pointer;
            transition: filter 0.2s, transform 0.15s;
            transform-origin: 110px 110px;
        }

        .donut-arc:hover {
            filter: brightness(1.1);
            transform: scale(1.04);
        }

        .donut-center-text {
            font-size: 14px;
            fill: #6b7280;
            text-anchor: middle;
        }

        .donut-center-number {
            font-size: 28px;
            font-weight: 700;
            fill: #111827;
            text-anchor: middle;
        }

        .donut-legend {
            display: flex;
            gap: 24px;
            font-size: 13px;
            color: #6b7280;
        }

        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Summary cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 36px;
        }

        .card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 18px 16px;
            text-align: center;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        .card-number {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.1;
        }

        .card-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
            line-height: 1.3;
        }

        .card-sublabel {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* Funnel mini-viz */
        .funnel-section {
            margin-top: 12px;
        }

        .funnel-title {
            font-size: 16px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 16px;
        }

        .funnel-stages {
            display: flex;
            align-items: center;
            gap: 0;
            justify-content: center;
        }

        .funnel-stage {
            text-align: center;
            position: relative;
        }

        .funnel-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .funnel-bar {
            border-radius: 6px;
            transition: all 0.5s ease;
            min-width: 40px;
        }

        .funnel-count {
            font-size: 22px;
            font-weight: 800;
            margin-top: 8px;
        }

        .funnel-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
            max-width: 120px;
        }

        .funnel-pct {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 1px;
        }

        .funnel-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 12px;
            color: #d1d5db;
        }

        .funnel-arrow-label {
            font-size: 11px;
            color: #9ca3af;
            white-space: nowrap;
        }

        .funnel-arrow svg {
            width: 32px;
            height: 20px;
        }

        /* Footer */
        .footer {
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
            font-size: 12px;
            color: #9ca3af;
            display: flex;
            justify-content: space-between;
        }

        /* Animations */
        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide {
            animation: slideIn 0.8s ease-out forwards;
            transform-origin: left;
        }

        .animate-fade {
            animation: fadeUp 0.5s ease-out forwards;
        }

        .animate-delay-1 { animation-delay: 0.1s; }
        .animate-delay-2 { animation-delay: 0.2s; }
        .animate-delay-3 { animation-delay: 0.3s; }
        .animate-delay-4 { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Issue Conversion Rate</h1>
        <div class="subtitle">MATSUlab discourse graph &middot; February 2026 snapshot &middot; EVD 1</div>

        <div class="evidence-statement">
            <strong>Result:</strong> 18% of MATSUlab issues (n=389) were claimed as experiments and 36% of those claimed at least one formal result node, yielding 44 total RES nodes.
        </div>

        <!-- Summary cards -->
        <div class="summary-cards">
            <div class="card animate-fade animate-delay-1">
                <div class="card-number" style="color: #6b7280;">389</div>
                <div class="card-label">Total Issues</div>
                <div class="card-sublabel">320 ISS + 69 experiments</div>
            </div>
            <div class="card animate-fade animate-delay-2">
                <div class="card-number" style="color: #2563eb;">69</div>
                <div class="card-label">Claimed</div>
                <div class="card-sublabel">17.7% conversion rate</div>
            </div>
            <div class="card animate-fade animate-delay-3">
                <div class="card-number" style="color: #7c3aed;">25</div>
                <div class="card-label">Produced Results</div>
                <div class="card-sublabel">36% of claimed</div>
            </div>
            <div class="card animate-fade animate-delay-4">
                <div class="card-number" style="color: #059669;">44</div>
                <div class="card-label">Total RES Nodes</div>
                <div class="card-sublabel">avg 1.8 per experiment</div>
            </div>
        </div>

        <!-- Two-panel layout -->
        <div class="panels">
            <!-- Left panel: stacked bar -->
            <div class="panel">
                <div class="panel-title">Issue Composition (n=389)</div>
                <div class="bar-container">
                    <div class="stacked-bar" id="stackedBar">
                        <!-- Segments will be rendered by JS -->
                    </div>
                    <div class="bracket">
                        <svg width="100%" height="28" id="bracketSvg">
                            <!-- Bracket rendered by JS -->
                        </svg>
                        <div class="bracket-label" id="bracketLabel"></div>
                    </div>
                </div>
                <div class="bar-legend" id="barLegend"></div>

                <!-- Mini funnel -->
                <div class="funnel-section">
                    <div class="funnel-title">Conversion Funnel</div>
                    <div class="funnel-stages" id="funnelStages"></div>
                </div>
            </div>

            <!-- Right panel: donut -->
            <div class="panel">
                <div class="panel-title">Claim Authorship (n=69 experiment claims)</div>
                <div class="donut-wrapper">
                    <svg class="donut-svg" viewBox="0 0 220 220" id="donutSvg">
                        <!-- Donut arcs rendered by JS -->
                    </svg>
                    <div class="donut-legend" id="donutLegend"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <span>Source: node-metrics analysis pipeline</span>
            <span>EVD 1 &middot; Evidence Bundle</span>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script>
    // ── Data ──
    const data = {
        segments: [
            { label: 'Claimed experiments', value: 69, color: '#2980b9', desc: 'Issues that were claimed as experiments — either via explicit Claimed By:: field, inferred from experimental log entries, or ISS pages with active work.' },
            { label: 'Unclaimed ISS', value: 320, color: '#bdc3c7', desc: 'ISS pages with no evidence of active work. Remain in the Issues board as open questions.' },
        ],
        totalIssues: 389,
        totalClaimed: 69,
        conversionPct: 17.7,
        authorship: [
            { label: 'Self-claims', value: 50, color: '#e67e22', desc: 'Issue creator and claimer are the same person.' },
            { label: 'Cross-person', value: 19, color: '#8e44ad', desc: 'A different researcher claimed the issue — representing idea exchange between lab members.' },
        ],
        authorshipTotal: 69,
        funnel: [
            { label: 'All Issues', value: 389, color: '#94a3b8', pct: '100%' },
            { label: 'Claimed', value: 69, color: '#2563eb', pct: '18%' },
            { label: 'With Results', value: 25, color: '#7c3aed', pct: '36% of claimed' },
            { label: 'RES Nodes', value: 44, color: '#059669', pct: 'avg 1.8 each' },
        ],
    };

    // ── Tooltip ──
    const tooltip = document.getElementById('tooltip');

    function showTooltip(e, html) {
        tooltip.innerHTML = html;
        tooltip.classList.add('visible');
        positionTooltip(e);
    }

    function hideTooltip() {
        tooltip.classList.remove('visible');
    }

    function positionTooltip(e) {
        const pad = 12;
        let x = e.clientX + pad;
        let y = e.clientY + pad;
        const rect = tooltip.getBoundingClientRect();
        if (x + rect.width > window.innerWidth - pad) x = e.clientX - rect.width - pad;
        if (y + rect.height > window.innerHeight - pad) y = e.clientY - rect.height - pad;
        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
    }

    document.addEventListener('mousemove', (e) => {
        if (tooltip.classList.contains('visible')) positionTooltip(e);
    });

    // ── Stacked Bar ──
    function renderStackedBar() {
        const bar = document.getElementById('stackedBar');
        const total = data.totalIssues;

        data.segments.forEach((seg, i) => {
            const el = document.createElement('div');
            el.className = 'bar-segment animate-slide';
            el.style.width = (seg.value / total * 100) + '%';
            el.style.backgroundColor = seg.color;
            el.style.animationDelay = (i * 0.12) + 's';

            if (seg.value > 20) {
                el.innerHTML = `<span class="segment-label">${seg.value}</span>`;
            }

            el.addEventListener('mouseenter', (e) => {
                const pct = (seg.value / total * 100).toFixed(1);
                showTooltip(e, `<strong>${seg.label}</strong><br>${seg.value} issues (${pct}%)<br><br>${seg.desc}`);
                // Dim other segments
                bar.querySelectorAll('.bar-segment').forEach((s, j) => {
                    if (j !== i) s.classList.add('dim');
                });
            });
            el.addEventListener('mouseleave', () => {
                hideTooltip();
                bar.querySelectorAll('.bar-segment').forEach(s => s.classList.remove('dim'));
            });

            bar.appendChild(el);
        });

        // Bracket
        const claimedWidth = (data.totalClaimed / total * 100);
        const svg = document.getElementById('bracketSvg');
        const containerWidth = bar.offsetWidth || 700;
        const bracketEnd = claimedWidth / 100 * containerWidth;

        svg.innerHTML = `
            <path d="M 2 2 L 2 14 L ${bracketEnd - 2} 14 L ${bracketEnd - 2} 2"
                  class="bracket-line" />
        `;

        document.getElementById('bracketLabel').innerHTML =
            `Claimed: ${data.totalClaimed} (${data.conversionPct}%)`;
    }

    // ── Bar Legend ──
    function renderBarLegend() {
        const legend = document.getElementById('barLegend');
        data.segments.forEach(seg => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `<div class="legend-dot" style="background:${seg.color}"></div><span>${seg.label} (${seg.value})</span>`;
            legend.appendChild(item);
        });
    }

    // ── Donut Chart ──
    function renderDonut() {
        const svg = document.getElementById('donutSvg');
        const cx = 110, cy = 110, r = 80, thickness = 36;
        const total = data.authorshipTotal;

        let currentAngle = -Math.PI / 2; // Start at top

        data.authorship.forEach((seg, i) => {
            const angle = (seg.value / total) * Math.PI * 2;
            const startAngle = currentAngle;
            const endAngle = currentAngle + angle;

            const x1 = cx + (r + thickness / 2) * Math.cos(startAngle);
            const y1 = cy + (r + thickness / 2) * Math.sin(startAngle);
            const x2 = cx + (r + thickness / 2) * Math.cos(endAngle);
            const y2 = cy + (r + thickness / 2) * Math.sin(endAngle);

            const x1i = cx + (r - thickness / 2) * Math.cos(startAngle);
            const y1i = cy + (r - thickness / 2) * Math.sin(startAngle);
            const x2i = cx + (r - thickness / 2) * Math.cos(endAngle);
            const y2i = cy + (r - thickness / 2) * Math.sin(endAngle);

            const largeArc = angle > Math.PI ? 1 : 0;
            const outerR = r + thickness / 2;
            const innerR = r - thickness / 2;

            const path = `
                M ${x1} ${y1}
                A ${outerR} ${outerR} 0 ${largeArc} 1 ${x2} ${y2}
                L ${x2i} ${y2i}
                A ${innerR} ${innerR} 0 ${largeArc} 0 ${x1i} ${y1i}
                Z
            `;

            const arc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            arc.setAttribute('d', path);
            arc.setAttribute('fill', seg.color);
            arc.setAttribute('stroke', 'white');
            arc.setAttribute('stroke-width', '3');
            arc.setAttribute('class', 'donut-arc');

            // Percentage label
            const midAngle = startAngle + angle / 2;
            const labelR = r + 2;
            const lx = cx + labelR * Math.cos(midAngle);
            const ly = cy + labelR * Math.sin(midAngle);

            const pctText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            pctText.setAttribute('x', lx);
            pctText.setAttribute('y', ly);
            pctText.setAttribute('text-anchor', 'middle');
            pctText.setAttribute('dominant-baseline', 'middle');
            pctText.setAttribute('fill', 'white');
            pctText.setAttribute('font-weight', '700');
            pctText.setAttribute('font-size', '14');
            pctText.setAttribute('pointer-events', 'none');
            const pctVal = Math.round(seg.value / total * 100);
            pctText.textContent = pctVal + '%';

            arc.addEventListener('mouseenter', (e) => {
                showTooltip(e, `<strong>${seg.label}</strong><br>${seg.value} of ${total} (${pctVal}%)<br><br>${seg.desc}`);
            });
            arc.addEventListener('mouseleave', hideTooltip);

            svg.appendChild(arc);
            svg.appendChild(pctText);

            currentAngle = endAngle;
        });

        // Center text
        const centerText1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        centerText1.setAttribute('x', cx);
        centerText1.setAttribute('y', cy - 6);
        centerText1.setAttribute('class', 'donut-center-number');
        centerText1.textContent = '69';
        svg.appendChild(centerText1);

        const centerText2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        centerText2.setAttribute('x', cx);
        centerText2.setAttribute('y', cy + 16);
        centerText2.setAttribute('class', 'donut-center-text');
        centerText2.textContent = 'claims';
        svg.appendChild(centerText2);

        // Legend
        const legend = document.getElementById('donutLegend');
        data.authorship.forEach(seg => {
            const item = document.createElement('div');
            item.className = 'donut-legend-item';
            item.innerHTML = `<div class="legend-dot" style="background:${seg.color}"></div><span>${seg.label} (${seg.value})</span>`;
            legend.appendChild(item);
        });
    }

    // ── Funnel ──
    function renderFunnel() {
        const container = document.getElementById('funnelStages');
        const maxVal = data.funnel[0].value;
        const maxBarHeight = 100;

        data.funnel.forEach((stage, i) => {
            // Stage block
            const stageEl = document.createElement('div');
            stageEl.className = 'funnel-stage';

            const barHeight = Math.max(24, (stage.value / maxVal) * maxBarHeight);
            const barWidth = Math.max(50, (stage.value / maxVal) * 140);

            stageEl.innerHTML = `
                <div class="funnel-bar-wrapper">
                    <div class="funnel-bar" style="
                        width: ${barWidth}px;
                        height: ${barHeight}px;
                        background: ${stage.color};
                        opacity: 0.85;
                    "></div>
                    <div class="funnel-count" style="color: ${stage.color}">${stage.value}</div>
                    <div class="funnel-label">${stage.label}</div>
                    <div class="funnel-pct">${stage.pct}</div>
                </div>
            `;

            container.appendChild(stageEl);

            // Arrow between stages
            if (i < data.funnel.length - 1) {
                const arrow = document.createElement('div');
                arrow.className = 'funnel-arrow';

                let arrowLabel = '';
                if (i === 0) arrowLabel = '18%';
                else if (i === 1) arrowLabel = '36%';
                else if (i === 2) arrowLabel = '1.8x';

                arrow.innerHTML = `
                    <svg viewBox="0 0 32 20" fill="none">
                        <path d="M 2 10 L 24 10 M 20 4 L 28 10 L 20 16" stroke="#d1d5db" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div class="funnel-arrow-label">${arrowLabel}</div>
                `;
                container.appendChild(arrow);
            }
        });
    }

    // ── Init ──
    document.addEventListener('DOMContentLoaded', () => {
        renderStackedBar();
        renderBarLegend();
        renderDonut();
        renderFunnel();

        // Re-render bracket on resize
        window.addEventListener('resize', () => {
            const bar = document.getElementById('stackedBar');
            const containerWidth = bar.offsetWidth;
            const claimedWidth = (data.totalClaimed / data.totalIssues * 100);
            const bracketEnd = claimedWidth / 100 * containerWidth;
            const svg = document.getElementById('bracketSvg');
            svg.innerHTML = `
                <path d="M 2 2 L 2 14 L ${bracketEnd - 2} 14 L ${bracketEnd - 2} 2"
                      class="bracket-line" />
            `;
        });
    });
    </script>
</body>
</html>
